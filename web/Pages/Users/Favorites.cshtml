@page
@model Atlas_Web.Pages.Users.FavoritesModel

@{
    Layout = null;
}
<div>
    @if (Model.Reports.Any() || Model.Collections.Any() || Model.Initiatives.Any() || Model.Terms.Any() || Model.Users.Any() || Model.Searches.Any() || Model.Groups.Any())
    {
        <section class="section my-5 p-0 is-flex is-flex-direction-row is-align-items-center">

            <div class="icon-text mr-5">
                <span class="icon">
                    <i class="fas fa-filter"></i>
                </span>
                <strong>Quick Filter</strong>
            </div>
            <div class="control has-icons-left mr-5">
                <input class="input favorites-filter" type="email" placeholder="type to filter...">
                <span class="icon is-small is-left">
                    <i class="fas fa-search"></i>
                </span>
            </div>

            @if(Model.Reports.Any()){
                <a class="button is-warning is-outlined has-text-dark favorites-filter mr-5" data-type="report">
                    <span class="icon">
                        <i class="fas fa-chart-bar"></i>
                    </span>
                    <span>Reports</span>
                </a>
            }
            @if(Model.Collections.Any()){
                <a class="button is-warning is-outlined has-text-dark favorites-filter mr-5" data-type="collection">
                    <span class="icon">
                        <i class="fas fa-project-diagram"></i>
                    </span>
                    <span>Collections</span>
                </a>
             }
             @if(Model.Initiatives.Any()){
                <a class="button is-warning is-outlined has-text-dark favorites-filter mr-5" data-type="initiative">
                    <span class="icon">
                        <i class="fas fa-lightbulb"></i>
                    </span>
                    <span>Initiatives</span>
                </a>
            }
            @if(Model.Terms.Any()){
                <a class="button is-warning is-outlined has-text-dark favorites-filter mr-5" data-type="term">
                    <span class="icon">
                        <i class="fas fa-book"></i>
                    </span>
                    <span>Terms</span>
                </a>
           }
           @if(Model.Users.Any()){
                <a class="button is-warning is-outlined has-text-dark favorites-filter mr-5" data-type="user">
                    <span class="icon">
                        <i class="fas fa-user"></i>
                    </span>
                    <span>Users</span>
                </a>
            }
            @if(Model.Groups.Any()){
                <a class="button is-warning is-outlined has-text-dark favorites-filter mr-5" data-type="group">
                    <span class="icon">
                        <i class="fas fa-users"></i>
                    </span>
                    <span>Groups</span>
                </a>
            }
            @if(Model.Searches.Any()){
                <a class="button is-warning is-outlined has-text-dark favorites-filter mr-5" data-type="search">
                    <span class="icon">
                        <i class="fas fa-search"></i>
                    </span>
                    <span>Searches</span>
                </a>
            }

        </section>
    }

    <div class="columns">
        @if (Model.Reports.Any() || Model.Collections.Any() || Model.Initiatives.Any() || Model.Terms.Any() || Model.Users.Any() || Model.Searches.Any() || Model.Groups.Any())
        {
            var total = Model.Reports.Count() + Model.Collections.Count() + Model.Initiatives.Count() + Model.Terms.Count() + Model.Users.Count() + Model.Searches.Count() + Model.Groups.Count();
            <div class="column is-one-quarter sticky is-align-self-flex-start">
                <div class="is-relative favorite-folders reorder">
                    <div class="box active favorites-show-all is-clickable is-relative" data-folderid="0">
                        <div class="icon-text">
                            <span class="icon mr-5 is-relative">
                                <i class="fas fa-folder-open fa-lg"></i>
                                <span class="tag fav-count is-primary is-rounded">@total</span>
                            </span>
                            <span>All</span>
                        </div>
                        @if (ViewBag.UserId == ViewBag.MyId || ViewBag.Permissions.Contains(41))
                        {
                            <div class="favorite-folder-controls button is-light is-rounded is-warning has-text-dark is-active">
                                <span class="icon js-modal-trigger" data-target="favorite-folder-new"><i class="fas fa-plus"></i></span>
                            </div>
                            <script>
                                (function(){
                                    document.querySelector('body').insertAdjacentHTML('beforeend', `
                                <div class="modal" id="favorite-folder-new">
                                    <div class="modal-background"></div>
                                    <div class="modal-content">
                                        <div class="box">
                                            <strong class="mb-5">New Folder</strong>

                                            <form method="post" action="/Users/Favorites/?handler=NewFolder" class="favorite-folder-new">
                                                <div class="field">
                                                    <div class="control">
                                                        <input class="input" name="favorite-folder-name"/>
                                                    </div>
                                                </div>
                                                    <button class="button pt-3">Save</button>
                                            </form>

                                        </div>
                                    </div>
                                    <button class="modal-close is-large" aria-label="close"></button>
                                </div>`)
                                })()
                            </script>
                        }
                    </div>

                    @foreach (var f in Model.Folders.OrderBy(x => x.FolderRank))
                    {
                        var folder_total = f.StarredCollections.Count() + f.StarredGroups.Count() + f.StarredInitiatives.Count() + f.StarredReports.Count() + f.StarredSearches.Count() + f.StarredTerms.Count() + f.StarredUsers.Count();
                        <div class="box favorites-folder is-clickable drg is-relative" data-folderid="@f.UserFavoriteFolderId" folder-rank="@if(f.FolderRank>0){@f.FolderRank} else {<text>999</text>}">
                            <div class="is-flex is-flex-direction-row is-justify-content-space-between">
                                <div class="icon-text">
                                    <span class="icon mr-5 is-relative">
                                        <i class="fas fa-folder fa-lg"></i>
                                        <span class="tag fav-count is-primary is-rounded">@folder_total</span>
                                    </span>
                                    <span class="favorite-folder-name">@f.FolderName</span>
                                </div>


                            </div>
                            @if (ViewBag.UserId == ViewBag.MyId || ViewBag.Permissions.Contains(41))
                            {
                                <div class="favorite-folder-controls button is-light is-rounded is-warning has-text-dark is-active">
                                    <span class="icon js-modal-trigger" data-target="favorite-folder-@f.UserFavoriteFolderId"><i class="fas fa-edit"></i></span>
                                    <span class="icon favorite-folder-delete" data-folderid="@f.UserFavoriteFolderId"><i class="fas fa-trash"></i></span>
                                    <span class="icon drg-hdl"><i class="fas fa-arrows-alt"></i></span>
                                </div>
                                <script>
                                    (function(){
                                        document.querySelector('body').insertAdjacentHTML('beforeend', `
                                    <div class="modal" id="favorite-folder-@f.UserFavoriteFolderId">
                                        <div class="modal-background"></div>
                                        <div class="modal-content">
                                            <div class="box">
                                                <strong class="mb-5">Rename Folder</strong>

                                                <form method="post" action="/Users/Favorites/?handler=EditFolder&id=@f.UserFavoriteFolderId" class="favorite-folder-rename" data-folderid="@f.UserFavoriteFolderId">
                                                    <div class="field">
                                                        <div class="control">
                                                            <input class="input" name="favorite-folder-name" value="@f.FolderName" />
                                                        </div>
                                                    </div>
                                                     <button class="button pt-3">Save</button>
                                                </form>

                                            </div>
                                        </div>
                                        <button class="modal-close is-large" aria-label="close"></button>
                                    </div>`)
                                    })()
                                </script>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="column favorites">
                <div class="columns is-multiline reorder">

                    @foreach (var t in Model.Reports.OrderBy(x => x.Rank))
                    {
                        <div class="column is-full favorite report drg is-relative" data-rank="@t.Rank" data-folderid="@t.Folderid" data-favoriteid="@t.StarId" data-type="report">
                            <button class="favorite-reorder button is-light is-rounded is-warning has-text-dark is-active drg-hdl" type="button">
                            <span class="icon">
                                <i class="fas fa-arrows-alt"></i>
                            </span>
                        </button>
                            <partial name="Reports/_Snippet" model="t.Report" />
                        </div>
                    }
                    @foreach (var t in Model.Collections.OrderBy(x => x.Rank))
                    {
                        <div class="column is-full favorite collection drg is-relative" data-rank="@t.Rank" data-folderid="@t.Folderid" data-favoriteid="@t.StarId" data-type="collection">
                            <button class="favorite-reorder button is-light is-rounded is-warning has-text-dark is-active drg-hdl" type="button">
                            <span class="icon">
                                <i class="fas fa-arrows-alt"></i>
                            </span>
                        </button>
                            <partial name="Collections/_Snippet" model="t.Collection" />
                        </div>
                    }
                    @foreach (var t in Model.Initiatives.OrderBy(x => x.Rank))
                    {
                        <div class="column is-full favorite initiative drg is-relative" data-rank="@t.Rank" data-folderid="@t.Folderid" data-favoriteid="@t.StarId" data-type="initiative">
                            <button class="favorite-reorder button is-light is-rounded is-warning has-text-dark is-active drg-hdl" type="button">
                            <span class="icon">
                                <i class="fas fa-arrows-alt"></i>
                            </span>
                        </button>
                            <partial name="Initiatives/_Snippet" model="t.Initiative" />
                        </div>
                    }
                    @foreach (var t in Model.Terms.OrderBy(x => x.Rank))
                    {
                        <div class="column is-full favorite term drg is-relative" data-rank="@t.Rank" data-folderid="@t.Folderid" data-favoriteid="@t.StarId" data-type="term">
                            <button class="favorite-reorder button is-light is-rounded is-warning has-text-dark is-active drg-hdl" type="button">
                            <span class="icon">
                                <i class="fas fa-arrows-alt"></i>
                            </span>
                        </button>
                            <partial name="Terms/_Snippet" model="t.Term" />
                        </div>
                    }
                    @foreach (var t in Model.Users.OrderBy(x => x.Rank))
                    {
                        <div class="column is-full favorite user drg is-relative" data-rank="@t.Rank" data-folderid="@t.Folderid" data-favoriteid="@t.StarId" data-type="user">
                            <button class="favorite-reorder button is-light is-rounded is-warning has-text-dark is-active drg-hdl" type="button">
                            <span class="icon">
                                <i class="fas fa-arrows-alt"></i>
                            </span>
                        </button>
                            <partial name="Groups/_Snippet" model="t.User" />
                        </div>
                    }
                    @foreach (var t in Model.Groups.OrderBy(x => x.Rank))
                    {
                        <div class="column is-full favorite group drg is-relative" data-rank="@t.Rank" data-folderid="@t.Folderid" data-favoriteid="@t.StarId" data-type="group">
                            <button class="favorite-reorder button is-light is-rounded is-warning has-text-dark is-active drg-hdl" type="button">
                            <span class="icon">
                                <i class="fas fa-arrows-alt"></i>
                            </span>
                        </button>
                            <partial name="Users/_Snippet" model="t.Group" />
                        </div>
                    }
                    @foreach (var t in Model.Searches.OrderBy(x => x.Rank))
                    {
                        <div class="column is-full favorite search drg is-relative" data-rank="@t.Rank" data-folderid="@t.Folderid" data-favoriteid="@t.StarId" data-type="search">
                            <button class="favorite-reorder button is-light is-rounded is-warning has-text-dark is-active drg-hdl" type="button">
                                <span class="icon">
                                    <i class="fas fa-arrows-alt"></i>
                                </span>
                            </button>
                            <partial name="Search/_Snippet" model="t" />
                        </div>
                    }
                </div>
                <script>
                    (function() {

                        // set the order correctly
                        var favs = Array.prototype.slice.call(document.querySelectorAll('.favorites .favorite')).sort(function comp($a, $b){
                            console.log($a.dataset.rank, $b.dataset.rank);
                            return +$a.dataset.rank - +$b.dataset.rank;
                        });

                        for (var i = 0; i < favs.length; i++) {
                            favs[i].parentElement.appendChild(favs[i]);
                        }
                    })()
                </script>
            </div>
        }
    </div>
</div>

               @* <div class="favs @if(!(ViewBag.UserId == ViewBag.MyId || ViewBag.Permissions.Contains(41))){<text>disabled</text>}" ss-container>
                    <div id="favs-none" @if (ViewBag.FavoriteReports.Count != 0) { <text> style="display:none;" </text> }>
                        <h5>No favorites here! ¯\_(ツ)_/¯</h5><br>
                        @if (ViewBag.UserId == ViewBag.MyId || ViewBag.Permissions.Contains(41))
                        {
                            <form asp-page-handler="DeleteFolder" method="post" id="DeleteFolderForm" style="display:none">
                                <h6>Want to<button type="submit" class="btn btn-link shake"><svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16zM53.2 467a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45L416 128H32z" /></svg></button>this folder?</h6>
                                <input type="hidden" id="Folder_UserFavoriteFolderId" name="Folder.UserFavoriteFolderId" value="" />
                            </form>
                        }
                    </div>

                    @foreach (var q in ViewBag.FavoriteReports)
                    {
                        <div class="fav drg" folder-id="@if(q.FolderId>0){@q.FolderId} else {<text>0</text>}" item-rank="@if(q.ItemRank>0){@q.ItemRank} else {<text>999</text>}" fav-id="@q.FavoriteId">
                            <div class="fav-links">
                                <div class="fav-star @if (ViewBag.UserId != ViewBag.MyId) {<text>disabled</text>} ">
                                    <i fav-type="@q.ItemType.ToLower()" object-id="@q.ItemId" class="far fa-star favorite"></i>
                                </div>
                                @if (@Configuration["features:enable_sharing"] == null || @Configuration["features:enable_sharing"].ToString().ToLower() == "true")
                                {
                                    <div class="fav-share darken" data-toggle="mdl" data-target="shareModal" data-name='@q.Name' data-url="/@q.AtlasUrl">
                                        <i class="fas fa-share"></i>
                                    </div>
                                }

                                <div class="fav-drg drg-hdl darken">
                                    <i class="fas fa-grip-lines"></i>
                                </div>
                            </div>
                            <div class="fav-body">
                                <div class="snippet-col">
                                    <div class="snippet-left">
                                        <figure class="image is-96x96 pop">
                                            <img data-src="/data/img?handler=Thumb&id=@q.ItemId&size=96x96" src="/img/loader.gif" />
                                        </figure>
                                    </div>
                                    <div class="snippet-right">
                                        <h5 class="fav-title" data-toggle="clps" data-target="clps-@q.FavoriteId">
                                            @if (q.ItemType == "Search")
                                            {
                                                <span class="darken">@q.Name.Split("&")[0].Replace("%20", " ").Replace("+", " ").Replace("?s=", "").Replace("s=", "")</span>
                                            }
                                            else
                                            {
                                                <span class="darken">
                                                    @q.Name @if (q.EpicRecordId != null && q.EpicRecordId != "")
                                                    {<text>&nbsp(@q.EpicMasterFile @q.EpicRecordId)</text>}
                                                </span>
                                            }

                                            <div class="fav-type">


                                            @if (q.EpicReleased == "Analytics Certified")
                                            {<span class="srch-fieldHunterGreen">@q.EpicReleased</span>}
                                            @if (q.EpicReleased == "Analytics Reviewed")
                                            {<span class="srch-fieldGreen">@q.EpicReleased</span>}
                                            @if (q.EpicReleased == "Epic Released")
                                            {<span class="srch-fieldOrange">@q.EpicReleased</span>}
                                            @if (q.EpicReleased == "Legacy")
                                            {<span class="srch-fieldOrange">@q.EpicReleased</span>}
                                            @if (q.EpicReleased == "High Risk")
                                            {<span class="srch-fieldRed">@q.EpicReleased</span>}
                                            @if (q.EpicReleased == "Self-Service")
                                            {<span class="srch-fieldBlue">@q.EpicReleased</span>}


                                @if (q.ItemType == "Search")
                                {
                                    var FilterString = q.Name.Contains("f=") ? q.Name.Split("f=")[1] : "";

                @if (FilterString == "28" || FilterString == "20" || FilterString == "21" || FilterString == "3" || FilterString == "17")
                {
        <span>@(FilterString == "28" ? "SSRS" : FilterString == "20" ? "Dashboard" : FilterString == "21" ? "Dash Component" : FilterString == "3" ? "Crystal" : FilterString == "17" ? "Workbench" : "")</span>}}
                                <span>@q.ItemType</span>
                            </div>
                        </h5>
                        <h5 class="fav-nav">
                            <a href="@q.AtlasUrl">Details</a>
                            @if (q.ItemType == "Report")
                            {
            @if (q.ReportUrl != null && q.ReportUrl != "")
            {
        <a class="ml-3" target="_blank" rel="noopener" href="@q.ReportUrl">Run</a> }
        else
        {
        if (q.EpicMasterFile == "IDB")
        {
        <div style="position: relative;">
            <span class="tt-top ml-3" style="color:grey;position: relative;cursor:default" data-tooltip="Open a related dashboard that uses this.">Run</span>
        </div> }
        else if (q.EditReportUrl != null && ViewBag.Permissions.Contains(38))
        {
        <div style="position: relative;">
            <span class="tt-top ml-3" style="color:grey;position: relative;white-space: nowrap;cursor:default" data-tooltip="Open in report library.">Run</span>
        </div> }
        else
        {
        <div style="position: relative;">
            <span class="tt-top ml-3" style="color:grey;position: relative;white-space: nowrap;cursor:default" data-tooltip="Run from the Hyperspace report library.">Run</span>
        </div>}
        }
                                @if (q.EditReportUrl != null && ViewBag.Permissions.Contains(38))
                                {
            <a class="ml-3" target="_blank" rel="noopener" href="@q.EditReportUrl">Edit</a>}
                                                    @if (q.ManageReportUrl != null && ViewBag.Permissions.Contains(38))
                                                    {
                                <a class="ml-3" target="_blank" rel="noopener" href="@q.ManageReportUrl">Manage</a>}}
                        </h5>
                        <div class="clps fav-dtls" id="clps-@q.FavoriteId">
                            <div class="markdown noleft">
                                @if (q.Description != null && q.Description != "")
                                {
                @Html.Raw(@Helpers.HtmlHelpers.MarkdownToHtml(q.Description)) }
            else
            {
        @:Open in Atlas to see details.
        }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>}
                </div>
            </div> }
            else if (ViewBag.TopRunReports.Count > 0)
            {
            <div class="favs-none">
                <div class="favs-noFavs" ss-container>
                    <h3 class="favs-noFavsTitle">Your last run reports</h3>
                    @foreach (var q in ViewBag.TopRunReports)
                    {
        <div class="fav">
            <div class="fav-body">
                <h5 class="fav-title" data-toggle="clps" data-target="clps-@q.ItemId">
                    <span>
                        @q.Name @if (q.EpicRecordId != null && q.EpicRecordId != "")
                        {<span> (@q.EpicMasterFile @q.EpicRecordId)</span>}
                    </span>
                </h5>
                <h5 class="fav-nav">
                    <a href="Reports?id=@q.ItemId">Open Documentation</a>
                    @if (q.ReportUrl != null && q.ReportUrl != "")
                    {
        <a class="ml-5" target="_blank" href="@q.ReportUrl">Run Report</a>}
                    @if (q.EditReportUrl != null && ViewBag.Permissions.Contains(38))
                    {
        <a class="ml-5" target="_blank" href="@q.EditReportUrl">Edit Report</a>}
                </h5>
                <div class="clps fav-dtls" id="clps-@q.ItemId">
                    @if (q.Description != null && q.Description != "")
                    {
        <div class="markdown noleft">
            @Html.Raw(@Helpers.HtmlHelpers.MarkdownToHtml(q.Description))
        </div>}
                </div>
            </div>
        </div>      }
                </div>
            </div> }
            else
            {
            <h4>Search to get started!</h4>}

            <script>
                (function(){
                   document.dispatchEvent(new CustomEvent('related-reports'));
                })();

                (function(){
                    var d = document;
                    @if(ViewBag.AdLists != null){
                        @:d.getElementById("AdColTwo").innerHTML +='@foreach(var ad in ViewBag.AdLists){@if(ad.Column == 2){<div class="col" data-ajax="yes" data-url="@ad.Url"></div>}}';
                        @:d.dispatchEvent(new CustomEvent('load-ajax-content'));
                    }
                })()
            </script>
        *@
