@*
    Atlas of Information Management business intelligence library and documentation database.
    Copyright (C) 2020  Riverside Healthcare, Kankakee, IL

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
*@

@model Data_Governance_WebApp.Pages.Projects.IndexModel

<h5 class="pt-2">New Milestone</h5>
<form asp-page-handler="AddMilestone" method="post" id=AddMilestone>
    <input asp-for="DpMilestone.DataProjectId" type="hidden" value='@Model.DataProject.Id' />
    <h6 class="pt-2">Description</h6>
    <textarea asp-for="DpMilestone.Description" required rows="1" type="text"  class="form-control" ></textarea>

    <h6 class="pt-2">Start Date</h6>
    <input asp-for="DpMilestone.StartDate" required type="date"  class="form-control" />

    <h6 class="pt-2">End Date</h6>
    <input asp-for="DpMilestone.EndDate" type="date"  class="form-control" />

    <h6 class="pt-2">Template</h6>

    <input type="dynamic-dropdown" asp-for="DpMilestone.MilestoneTemplateId"  search-area="mile-type" method="fullList" />

    <h6 class="pt-2">Owner</h6>

    <input type="dynamic-dropdown" asp-for="DpMilestone.OwnerId" value="" visible-value="" search-area="UserSearch" />

    <h6 class="pt-2">(Optional) Task List - blank boxs automatically removed.</h6>
    <textarea class="form-control checklistitem mb-2" rows="1"></textarea>
    <input type='hidden' name='DpChecklist' value='' />

    <button class='btn btn-link pt-1 mt-1' type="submit">Save</button>
</form>

@foreach (var t in Model.DataProject.MilestoneTasks)
{
    <div class="row">
        <div class="col d-flex justify-content-start">
            <form asp-page-handler="DeleteMilestone" method="post">
                <input asp-for="DpMilestone.MilestoneTaskId" type="hidden" value="@t.Id" />
                <input asp-for="DpMilestone.DataProjectId" type="hidden" value="@Model.DataProject.Id" />
                <button class="btn btn-link" type="submit"><svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16zM53.2 467a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45L416 128H32z"/></svg></button>
            </form>
            <button class="btn btn-link atlas-blue"  type="button" data-toggle="clps" data-target="milestone-@t.Id">@t.Description - @t.Template - @t.Owner (@t.StartDate thu @t.EndDate)</button>
        </div>

    </div>
     <div class="row clps" id="milestone-@t.Id">
        <div class="col">
            <div class="card bg-white p-3">
                <form asp-page-handler="EditMilestone" method="post">
                    <input asp-for="DpMilestone.MilestoneTaskId" type="hidden" value="@t.Id" />
                    <input asp-for="DpMilestone.DataProjectId" type="hidden" value="@Model.DataProject.Id" />

                    <h6 class="pt-2">Description</h6>
                    <textarea rows=1 class="form-control" id="DpMilestone_Description" name="DpMilestone.Description">@t.Description</textarea>

                    <h6 class="pt-2">Start Date</h6>
                    <input asp-for="DpMilestone.StartDate" required type="date"  class="form-control" value="@t.StartDate"/>

                    <h6 class="pt-2">End Date</h6>
                    <input asp-for="DpMilestone.EndDate" type="date" class="form-control" value="@t.EndDate"/>

                    <h6 class="pt-2">Template</h6>
                    <input type="dynamic-dropdown" asp-for="DpMilestone.MilestoneTemplateId" value="@t.TemplateId" visible-value="@t.Template" search-area="mile-type" method="fullList" />

                    <h6 class="pt-2">Owner</h6>
                    <input type="dynamic-dropdown" asp-for="DpMilestone.OwnerId" value="@t.OwnerId" visible-value="@t.Owner" search-area="UserSearch" />

                    <h6 class="pt-2">(Optional) Task List - blank boxs automatically removed.</h6>
                    @foreach(var q in t.Checklist)
                    {
                        <textarea class="form-control checklistitem mb-2" rows="1">@q.Item</textarea>
                    }
                    <textarea class="form-control checklistitem mb-2" rows="1"></textarea>
                    <input type='hidden' name='DpChecklist' value='' />
                <button class='btn btn-link pt-1 mt-1' type="submit">Save</button>
                </form>
            </div>
        </div>
    </div>
}

<script>
     if(document.readyState === 'complete') {
    load()
        }

        window.addEventListener('load',function(){
 load()
  })


function load(){
  function UpdateMilestoneChecklistItems(e){var t=e.closest("form");if(null==e.nextElementSibling||null!==e.nextElementSibling&&!e.nextElementSibling.classList.contains("checklistitem")){var n=e.cloneNode(!0);n.value="",e.parentNode.insertBefore(n,e.nextSibling)}var i=t.querySelector('input[name="DpChecklist"]'),l="",c=0;[].map.call(t.getElementsByClassName("checklistitem"),function(e){var t=e.value.trim();console.log(t),""!=t&&(l+='"'+(c+=1)+'":"'+t+'",')}),l.length>0&&(i.value="{"+l.substring(0,l.length-1)+"}")}document.addEventListener("click",function(e){e.target.matches(".checklistitem")&&UpdateMilestoneChecklistItems(e.target)}),document.addEventListener("focus",function(e){e.target.matches(".checklistitem")&&UpdateMilestoneChecklistItems(e.target)}),document.addEventListener("change",function(e){e.target.matches(".checklistitem")&&UpdateMilestoneChecklistItems(e.target)}),document.addEventListener("keyup",function(e){e.target.matches(".checklistitem")&&UpdateMilestoneChecklistItems(e.target)});var cli=document.querySelectorAll("form#AddMilestone textarea.checklistitem");for(var x=0;x<cli.length;x++){UpdateMilestoneChecklistItems(cli[x])};
  }


</script>